<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>recorder - Introduction to Netidx</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="quick_start.html"><strong aria-hidden="true">1.</strong> Quick Start</a></li><li class="chapter-item expanded "><a href="overview.html"><strong aria-hidden="true">2.</strong> Overview</a></li><li class="chapter-item expanded "><a href="examples_overview.html"><strong aria-hidden="true">3.</strong> Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="vmstat_example.html"><strong aria-hidden="true">3.1.</strong> Publishing vmstat</a></li><li class="chapter-item expanded "><a href="integration_example.html"><strong aria-hidden="true">3.2.</strong> Integration into an Existing System</a></li><li class="chapter-item expanded "><a href="complete_system.html"><strong aria-hidden="true">3.3.</strong> Clean Slate System Design</a></li></ol></li><li class="chapter-item expanded "><a href="administration.html"><strong aria-hidden="true">4.</strong> Administration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="configuration.html"><strong aria-hidden="true">4.1.</strong> Configuration</a></li><li class="chapter-item expanded "><a href="authorization.html"><strong aria-hidden="true">4.2.</strong> Authorization</a></li><li class="chapter-item expanded "><a href="startup.html"><strong aria-hidden="true">4.3.</strong> Running the Resolver Server</a></li><li class="chapter-item expanded "><a href="subscription_flow.html"><strong aria-hidden="true">4.4.</strong> Subscription Flow</a></li><li class="chapter-item expanded "><a href="fault_tolerance.html"><strong aria-hidden="true">4.5.</strong> Fault Tolerance</a></li></ol></li><li class="chapter-item expanded "><a href="tools_overview.html"><strong aria-hidden="true">5.</strong> Command Line Tools</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="publisher_tool.html"><strong aria-hidden="true">5.1.</strong> publisher</a></li><li class="chapter-item expanded "><a href="subscriber_tool.html"><strong aria-hidden="true">5.2.</strong> subscriber</a></li><li class="chapter-item expanded "><a href="resolver_tool.html"><strong aria-hidden="true">5.3.</strong> resolver</a></li><li class="chapter-item expanded "><a href="recorder_tool.html" class="active"><strong aria-hidden="true">5.4.</strong> recorder</a></li><li class="chapter-item expanded "><a href="stress_tool.html"><strong aria-hidden="true">5.5.</strong> stress</a></li></ol></li><li class="chapter-item expanded "><a href="browser_overview.html"><strong aria-hidden="true">6.</strong> Browser</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="browser_views.html"><strong aria-hidden="true">6.1.</strong> Constructing Custom Views</a></li><li class="chapter-item expanded "><a href="browser_scripting.html"><strong aria-hidden="true">6.2.</strong> BScript</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Introduction to Netidx</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#recorder" id="recorder">Recorder</a></h1>
<p>The recorder allows you to subscribe to a set of paths defined by one
or more globs and write down their values in a file with a compact
binary format. Moreover, at the same time it can make the contents of
an archive available for playback by multiple simultaneous client
sessions, each with a potentially different start time, playback
speed, end time, and position.</p>
<p>It's possible to set up a recorder to both record data and play it
back at the same time, or only record, or only play back. It is not
possible to set up one recorder to record, and another to play back
the same file, however recording and playback are careful not to
interfere with each other, so the only limitation should be the
underlying IO device and the number of processor cores available.</p>
<h2><a class="header" href="#args" id="args">Args</a></h2>
<ul>
<li>Args that apply to both recording and playback
<ul>
<li><code>--archive &lt;file&gt;</code>: required by both modes of operation, the name
of the file to record the data into or play it back from. If an
existing archive is specified and recording is requested then the
data will be appended to that archive.</li>
<li><code>--shards &lt;n&gt;</code>: optional, The number of recorder shards to
expect. If you want to record/playback a huge namespace, or one
that updates a lot, it may not be possible to use just one
computer. The recorder supports sharding across an arbitrary
number of processes for both recording and playback. n is the
number of shards that are expected in a given
cluster. recording/playback will not begin until all the shards
have appeared and synced with each other. default 1.</li>
<li><code>-f, --foreground</code>: don't daemonize</li>
</ul>
</li>
<li>Args that apply to recording
<ul>
<li><code>--spec &lt;glob&gt;</code>: required by recording, enables recording if
specified, may be specified multiple times, a glob describing what
to archive. If multiple globs are specified and they overlap, the
overlapped items will only be archived once.</li>
<li><code>--flush-frequency &lt;pages&gt;</code>: optional, How much data to write before
flushing to disk in pages, where a page is a filesystem page,
however large that is on your system. default 65534. This is the
maximum amount of data you will probably lose in a power outage,
system crash, or program crash. The recorder uses two phase commits
to the archive file to ensure that partially written data does not
corrupt the file.</li>
<li><code>--flush-interval &lt;seconds&gt;</code>: optional, How long in seconds to wait
before flushing data to disk even if <code>flush-frequency</code> pages was not
yet written. 0 to disable, default 30.</li>
<li><code>--image-frequency &lt;bytes&gt;</code>: optional, How often, in bytes, to write a full
image of every current value, even if it did not update. Writing
images increases the file size, but makes seeking to an arbitrary
position in the archive much faster. 0 to disable images, in which
case a seek back will read all the data before the requested
position, default 64MiB.</li>
<li><code>--poll-interval &lt;seconds&gt;</code>: optional, How often, in seconds, to
poll the resolver server for changes to the specified glob set. 0
never poll, default 5.</li>
</ul>
</li>
<li>Args that apply to playback
<ul>
<li><code>--publish-base &lt;path&gt;</code>: required for playback, enables playback
if specified, the path where playback sessions will be published.</li>
<li><code>--bind &lt;spec&gt;</code>: required for playback, a specification describing
the network interface to bind to. See
<a href="./publisher_tool.html">publisher</a> for details.</li>
<li><code>--spn &lt;service-principal&gt;</code>: optional, required for kerberos, the
service princial to publish as.</li>
<li><code>--max-sessions &lt;n&gt;</code>: optional, How many total client sessions to allow at
any given time. When a session is no longer used, it will be
garbage collected. default 256.</li>
<li><code>--max-sessions-per-client &lt;n&gt;</code>: optional, The maximum number of
sessions a single client is allowed to have. default 64.</li>
</ul>
</li>
</ul>
<h2><a class="header" href="#using-playback-sessions" id="using-playback-sessions">Using Playback Sessions</a></h2>
<p>When initially started for playback or mixed operation the recorder
publishes only some cluster information, and a netidx rpc called
<code>session</code> under the <code>publish-base</code>. Calling the session rpc will
create a new session, and return the session id. Then it will publish
the actual playback session under <code>publish-base/session-id</code>. A
playback session consists of two sub directories, <code>control</code> contains
readable/writable values that control the session, and <code>data</code> contains
the actual data.</p>
<h3><a class="header" href="#creating-a-new-session" id="creating-a-new-session">Creating a New Session</a></h3>
<p>It's simple to call a netidx rpc with command line tools, the browser,
or programatically. To create a new playback session with default
values just write <code>null</code> to <code>publish-base/session</code>. e.g.</p>
<pre><code>netidx subscriber /archive/session
WRITE|/archive/session|string|null
/archive/session|string|ef93a9dce21f40c49f5888e64964f93f
</code></pre>
<p>We just created a new playback session called
ef93a9dce21f40c49f5888e64964f93f, we can see that the recorder
published some new things there,</p>
<pre><code>$ netidx resolver list /archive/ef93a9dce21f40c49f5888e64964f93f/*
/archive/ef93a9dce21f40c49f5888e64964f93f/data
/archive/ef93a9dce21f40c49f5888e64964f93f/cluster
/archive/ef93a9dce21f40c49f5888e64964f93f/control
</code></pre>
<p>If we want to pass some arguments to the rpc so our session will be
setup how we like by default we can do that as well, e.g.</p>
<pre><code>netidx subscriber /archive/session /archive/session/start/val /archive/session/speed/val
WRITE|/archive/session/start/val|string|-3d
WRITE|/archive/session/speed/val|f32|2
WRITE|/archive/session|string|null
/archive/session|string|ef93a9dce21f40c49f5888e64964f93f
</code></pre>
<p>And now our new session would be setup to start 3 days ago, and
playback at 2x speed.</p>
<h3><a class="header" href="#playback-controls" id="playback-controls">Playback Controls</a></h3>
<p>Once we've created a new session the recorder publishes some controls
under the control directory. The five controls both tell you the state
of the playback session, and allow you to control it. They are,</p>
<ul>
<li><code>start</code>: The timestamp you want playback to start at, or Unbounded
for the beginning of the archive. This will always display
Unbounded, or a timestamp, but it in addition to those two values it
accepts writes in the form of offsets from the current time,
e.g. -3d would set the start to 3 days ago. It accepts offsets
[+-]N[yMdhms] where N is a number. y - years, M - months, d - days,
h - hours, m - minutes, s - seconds.</li>
<li><code>end</code>: Just like start except that Unbounded, or a time in the
future means that when playback reaches the end of the archive it
will switch mode to tail. In tail mode it will just repeat data as
it comes in. In the case that end is in the future, but not
unbounded, it will stop when the future time is reached.</li>
<li><code>pos</code>: The current position, always displayed as a timestamp unless
there is no data in the archive. Pos accepts writes in the form of
timestamps, offsets from the current time (like start and end), and
[+-]1-128 batches. e.g. -10 would seek back exactly 10 update
batches, +100 would seek forward exactly 100 update batches.</li>
<li><code>speed</code>: The playback speed as a fraction of real time, or
Unlimited. In the case of Unlimited the archive is played as fast as
it can be read, encoded, and sent. Otherwise the recorder tries to
play back the archive at aproximately the specified fraction of real
time. This will not be perfect, because timing things on computers
is hard, but it tries to come close.</li>
<li><code>state</code>: this is either play, pause or tail, and it accepts writes
of any state and will change to the requested state if possible.</li>
</ul>
<p>Since the controls also include a small amount of documentation meant
to render as a table, the actual value that you read from/write to is
<code>publish-base/session-id/control/name-of-control/current</code>.</p>
<h3><a class="header" href="#data" id="data">Data</a></h3>
<p>Once the session is set up the data, whatever it may be, appears under
<code>publish-base/data</code>. Every path that ever appears in the archive is
published from the beginning, however, if at the current <code>pos</code> that
path didn't have a value, then it will be set to <code>null</code>. This is a
slightly unfortunate compromise, as it's not possible to tell the
difference between a path that wasn't available, and one that was
intentionally set to null. When you start the playback values will be
updated as they were recorded, including replicating the observed
batching.</p>
<h3><a class="header" href="#deleting-a-playback-session" id="deleting-a-playback-session">Deleting a Playback Session</a></h3>
<p>Simply stop subscribing to any value or control in the session and the
recorder will delete it within about 30 seconds. At the moment there
is no other way to delete a session, but that's a feature that would
be easy to add if it was needed.</p>
<h2><a class="header" href="#example" id="example">Example</a></h2>
<p>To record and publish the archive of the data generated by my solar
installation I use the following command.</p>
<pre><code>netidx record \
    --archive ~/solar \
    --spec '/solar/{control,stats,settings}/**' \
    --bind 192.168.0.0/24 \
    --spn publish/blackbird.ryu-oh.org@RYU-OH.ORG \
    --publish-base /solar/archive
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="resolver_tool.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="stress_tool.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="resolver_tool.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="stress_tool.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
